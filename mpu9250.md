# MPU9250
## 1.简介
MPU9250是一个多芯片模组，包含了两个裸片集成在一个QFN封装中。一片是3轴陀螺仪和3轴加速度计MPU6500，另一片是3轴磁力计AK8963。因此，这是一个9轴的运动检测设备，包括3轴陀螺仪、3轴加速度计、3轴磁力计和一个数字运动处理器（DMP）。
## 2.功能
### 2.1.DMP
DMP是MPU9250内部的一个数字运动处理单元。通过对DMP的配置，可以获取经过处理后的数据，如角速度、加速度、四元数等。DMP可以根据需要配置成不同的特性和功能。除了计步数据，其余的DMP数据均输出到MPU9250的FIFO中。 

 - 3轴低功耗四元数
 - 6轴低功耗四元数
 - 方向姿态识别
 - 轻触姿态识别
 - 计步姿态识别
 - DMP中断

当DMP使能时，将会以200Hz的速率对传感器进行采样。设置FIFO的输出速率就是数据的输出速率，DMP将会在数据每一次传入FIFO时产生一个中断。

### 2.2.MPL库
MPL是Invensense专有的算法库，用于传感器的数据融合和动态标定。Motin Driver将传感器数据传给MPL lib，MPL对数据进行融合。在使能MPL库之前需要对MPL的特性进行配置。

### 2.3.磁力计AK8963
AK8963与MPU的辅助IIC总线相连，相当于MPU的一个从机。在读取的时候，MPU工作在主机模式。
#### 2.3.1.IIC读写AK8963
当处理器与MPU通过IIC接口连接时，处理器可以直接与辅助IIC总线上的设备通信，相当于透传功能。只要读写的时候选择从机地址便可以正常通信。
#### 2.3.2.SPI读写AK8963
使用SPI读写AK8963就有一些麻烦。处理器使用SPI通过MPU间接的与AK8963通信。每次读写，处理器将AK8963寄存器地址、待读/写的数据写入MPU内部的IIC从机配置寄存器。以此完成一次单字节通信。
#### 2.3.3 数据存储
AK8963作为MPU从机，通过配置MPU的寄存器，可以相对灵活的使用AK8963。可将MPU配置成自动、以一定采样速率从AK8963的数据寄存器读取数据存入到MPU的外部传感器寄存器(EXT\_SENS\_DATA)。还可根据IIC的时钟速率、数据读取时延等配置MPU的IIC。

### 2.4 PIN Definition
可配置FSYNC引脚连接到外部传感器，通过该pin将外部传感器产生的中断信号通过MPU的INT引脚传递给处理器。
## 3.融合数据读取
从DMP读取角速度、加速度、四元数数据，从寄存器读取温度、磁力计数据，传入MPL库，由MPL库进行解算。在需要非阻塞的情况下，可以将所有数据先存入到FIFO中，当产生中断时，启动SPI的DMA传输，将FIFO的数据放到内存当中。在主任务中把数据传给MPL并进行解析处理。
## 4.MD6.12对寄存器的配置
> reg\_lpf:0x02
> i2c\_delay\_ctrl:0x03
> s4\_ctrl:sample\_rate/rate - 1
> reg\_rate\_div:0x00

采样率被配置为1kHz，
## Attention
如果使用SPI与MPU相连接，在移植MPL库时，应注意不能直接使用i2c\_write和i2c\_read接口与磁力计通信。应将对磁力计通信的函数改为spi读写模式下对应的函数。 
